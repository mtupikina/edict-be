---
description: Keep test coverage at least 90%
globs: "**/*.ts"
alwaysApply: false
---

# Test Coverage (≥ 90%)

- **Minimum coverage:** Statements, branches, functions, and lines must each be **at least 90%** for the application source (excluding `main.ts` and test files).
- **Unit tests:** Every service, guard, controller, and strategy with business logic must have a `.spec.ts` that tests behavior. Mock Mongoose models and external deps where needed.
- **All new code** must be covered by tests; **code cannot be committed** unless coverage stays ≥ 90% (see commit-gate-tests-and-lint).
- **Tests with every change:** Add or update `.spec.ts` tests whenever you add or change application code (services, controllers, guards, etc.). Coverage must never fall below 90%.
- **CI:** Run `npm run test:cov` and fail the build if coverage drops below 90%. A Jest `coverageThreshold` is set in `package.json` so `npm run test:cov` fails when any of statements/branches/functions/lines drop below 90%.
- When adding or changing features, add or update specs so coverage stays ≥ 90%.
